# Architecture Overview

## Contracts

### OrderbookFactory
- Responsible for creating and managing orderbooks.
- Handles fee recipient configuration and IRM (Interest Rate Model) enablement.
- Deploys new Orderbook contracts and maintains a registry of all created orderbooks.

### Orderbook
- Manages lending and borrowing orders.
- Implements a red-black tree structure for efficient order matching.
- Facilitates whitelisting of pools and manages their interactions.
- Handles borrower and lender orders, including market and limit orders.

### Pool
- Represents individual lending pools.
- Implements ERC-4626 for tokenized vaults.
- Manages deposits, withdrawals, borrowing, repayment, and liquidating.
- Tracks collateral and ensures healthy positions for borrowers.
- Interacts with the `Orderbook` for order creation and liquidity allocation.

### Libraries
- **AugmentedRedBlackTreeLib**: Implements a red-black tree for efficient order storage and retrieval.
- **OrderbookLib**: Provides utility functions for managing red-black trees and order matching. 
- **EventsLib**: Defines events emitted across the system.
- **ErrorsLib**: Defines custom error messages for reverts.

# Flow of the System

## Orderbook Creation
1. The `OrderbookFactory` contract is deployed by the owner.
2. The owner calls `createOrderbook` on the factory, specifying:
    - Loan token address.
    - Collateral token address.
    - Pool makers (addresses authorized to create pools).
3. A new `Orderbook` contract is deployed and initialized with the provided parameters.
4. The `Orderbook` is registered in the factory's mapping and added to the list of all orderbooks.

## Pool Creation
1. A pool maker (authorized by the `Orderbook`) calls `whitelistPool` on the `Orderbook`.
2. The pool must use an enabled IRM, and the pool manager must be authorized.
4. The new pool is registered in the `Orderbook` and added to whitelisted pools.

## Lending Flow
1. A lender deposits assets into a pool by calling `deposit` or `mint` on the `Pool`.
2. The pool updates its internal state to reflect the new liquidity.
3. The pool generates lending orders and inserts them into the `Orderbook` using `batchInsertOrder`.
4. The `Orderbook` stores the orders in its red-black tree for efficient matching.

## Borrowing Flow
1. A borrower initiates a borrow request by calling `matchMarketBorrowOrder` or `insertLimitBorrowOrder` on the `Orderbook`.
2. The `Orderbook` matches the borrow request with available lending orders in its red-black tree.
3. The borrower provides collateral, which is transferred to the relevant pools.
4. The pools process the borrow request, transferring loan tokens to the borrower and updating their internal state.

## Repayment Flow
1. A borrower repays their debt by calling `repay` on the `Pool`.
2. The pool updates the borrower's position and reduces its total borrow assets.
3. If the debt is fully repaid, the borrower can withdraw their collateral.

## Liquidation Flow
1. If a borrower's position becomes unhealthy (e.g., due to a drop in collateral value), it can be liquidated.
2. A liquidator calls `liquidate` on the `Pool`, specifying the borrower and the amount to seize.
3. The pool transfers the seized collateral to the liquidator and reduces the borrower's debt.

# Relationships Between Contracts

- **OrderbookFactory ↔ Orderbook**
  - The factory creates and manages multiple orderbooks.
  - Each orderbook is associated with a unique pair of loan and collateral tokens.

- **Orderbook ↔ Pool**
  - The `Orderbook` manages orders and interacts with pools for liquidity and collateral management.
  - Pools insert lending orders into the `Orderbook`.

- **Pool/Orderbook ↔ Borrowers/Lenders**
  - Borrowers can interact with pools/orderbook to borrow assets and provide collateral.
  - Lenders interact with pools to deposit assets and earn interest.

# Order Matching

1. **Order Insertion**:
   - Lender orders inserted by pools via `batchInsertOrder`
   - Borrower limit orders inserted via `insertLimitBorrowOrder`
   - Orders stored in red-black trees based on rate and LTV

2. **Market Order Matching**:
   - Find best available rate in lender tree
   - Match against orders at that rate
   - Repeat until order is filled or no matching orders remain

3. **Limit Order Matching**:
   - Limit orders stored until conditions are favorable
   - When matched (manually triggered), similar process to market orders

# Order Types and Matching Logic

### Lender Orders
- Automatically generated by pools based on their available liquidity
- Inserted into the lender tree with rate, LTV, and amount
- Ordered by rate (higher rates first) and then LTV

### Borrower Orders
- **Market Orders**: Executed immediately at the best available rate
- **Limit Orders**: Stored in the borrower tree until conditions are favorable
  - Collateral held in escrow by the orderbook
  - Can be canceled by the borrower
  - Can be matched when conditions are favorable

### Matching Logic
- Uses red-black trees for efficient ordering and matching
- For market orders, tries to fill from the best available rate
- Aggregates matched orders by pool to minimize transactions
- Handles partial fills and cancellations

### Lending Flow Diagram
```
Lender ───► Pool ───► Orderbook
   ▲         │             │
   │         ▼             │
   └────── Shares          ▼
                     Lender Tree
```

### Borrowing Flow Diagram
```
┌───────────────┐          ┌─────────────┐           ┌────────────┐
│   Borrower    │          │  Orderbook  │           │   Pools    │
└───────┬───────┘          └──────┬──────┘           └─────┬──────┘
        │                         │                        │
        │ matchMarketBorrowOrder( │                        │
        │   amount,               │                        │
        │   minAmountExpected,    │                        │
        │   collateralBuffer)     │                        │
        ├────────────────────────►│                        │
        │                         │                        │
        │                         │ match with best rates  │
        │                         ├─────────┐              │
        │                         │         │              │
        │                         │◄────────┘              │
        │                         │                        │
        │                         │ aggregate pool data    │
        │                         ├─────────┐              │
        │                         │         │              │
        │                         │◄────────┘              │
        │                         │                        │
        │                         │ transfer collateral    │
        │                         │ from borrower          │
        │                         ├─────────┐              │
        │                         │         │              │
        │                         │◄────────┘              │
        │                         │                        │
        │                         │ for each matched pool: │
        │                         ├───────────────────────►│
        │                         │                        │
        │                         │ supply collateral      │
        │                         │ and call borrow        │
        │                         │───────────────────────►┤
        │                         │                        │
        │ loan tokens received    │                        │
        │◄────────────────────────┤                        │
        │                         │                        │
```

### Additional info:
- Pool will spread the liquidity in ticks and only 10 ticks will create the orders.
- When matching of borrow order that is for more liquidity than quoted in the OB then only quoted liquidity will be matched in case of market order and rest of the liquidity will then quoted to the OB once the order is complete
- There is a limit of MAX_MATCHED_ORDER to 30 and is a intended behavior.

# Licensing
The primary license for Avon Tech ltd. is the Business Source License 1.1 (BUSL-1.1), see  [`license`](../LICENSE). Following files are licensed under the BUSL-1.1 license:
- `src/OrderbookFactory.sol`
- `src/Orderbook.sol`
- `src/libraries/OrderbookLib.sol`

The `AugmentedRedBlackTreeLib.sol` file is licensed under the MIT license from [Vectorized/solady](https://github.com/Vectorized/solady/blob/main/src/utils/RedBlackTreeLib.sol) and rest of the files in `src/interface` and `src/libraries` can be considered under GPL-2.0 license or later.